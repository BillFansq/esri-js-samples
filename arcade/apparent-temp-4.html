<!DOCTYPE html>
<html>

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Arcade - temperatures</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.2/esri/css/main.css">
<script src="https://js.arcgis.com/4.2/"></script>

<style>
  html, body, 
  #viewDiv {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
  }
</style>
  
<!--------------------->  
<!-- ARCADE SCRIPTS  -->
<!--------------------->
  
  
<!--WIND CHILL-->
  
<script type="text/esri-arcade" id="wind-chill">
  var t = $feature.TEMP;
  // convert speed from kph to mph
  var ws = $feature.WIND_SPEED * 0.621371;

  var wc = 35.74 + (0.6215 * t) - (35.75 * Pow(ws, 0.16)) + (0.4275 * t * Pow(ws, 0.16))

  // Only for temps below 50F and WS > 3mph
  // wind chill must be lower than the temperature
  return IIF(t <= 50 && ws >= 3 && wc < t, wc, null);
</script>
  
<!--HEAT INDEX-->
  
<script type="text/esri-arcade" id="heat-index">
  var c1 = -42.379;
  var c2 = 2.04901523;
  var c3 = 10.14333127;
  var c4 = -0.22475541;
  var c5 = -0.00683783;
  var c6 = -0.05481717;
  var c7 = 0.00122874;
  var c8 = 0.00085282;
  var c9 = -0.00000199;

  var t = $feature.TEMP;
  var r = $feature.R_HUMIDITY;

  var hi = c1 + (c2 * t) + (c3 * r) 
    + (c4 * t * r) + (c5 * t * t) 
    + (c6 * r * r) + (c7 * t * t * r) 
    + (c8 * t * r * r) + (c9 * t * t * r * r);

  // Only for temps above 80F
  return IIF(t >= 80, hi, null);
</script>
  
<!--APPARENT TEMPERATURE (HOW IT FEELS)-->
  
<script type="text/esri-arcade" id="apparent-temp">
  var t = $feature.TEMP;
  var ws = $feature.WIND_SPEED * 0.621371;  // convert to mph
  var r = $feature.R_HUMIDITY;

  // WIND CHILL

  var wc = 35.74 + (0.6215 * t) 
    - (35.75 * Pow(ws, 0.16)) 
    + (0.4275 * t * Pow(ws, 0.16));

  // HEAT INDEX

  var c1 = -42.379;
  var c2 = 2.04901523;
  var c3 = 10.14333127;
  var c4 = -0.22475541;
  var c5 = -0.00683783;
  var c6 = -0.05481717;
  var c7 = 0.00122874;
  var c8 = 0.00085282;
  var c9 = -0.00000199;

  var hi = c1 + (c2 * t) + (c3 * r) 
    + (c4 * t * r) + (c5 * t * t) 
    + (c6 * r * r) + (c7 * t * t * r) 
    + (c8 * t * r * r) + (c9 * t * t * r * r);

  // apparent temperature
  var apTemp = WHEN(  
      // Only for temps below 50F and WS > 3mph
      // wind chill must be lower than the temperature
    t <= 50 && ws >= 3 && wc < t, wc,
      // Only for temps above 80F
    t >= 80, hi, 
      t
  );
  return apTemp;
</script>
  
<!--DIFFERENCE BETWEEN APPARENT (FELT) TEMPERATURE AND MEASURED AIR TEMPERATURE-->
  
<script type="text/esri-arcade" id="felt-temp-diff">
  var t = $feature.TEMP;
  var ws = $feature.WIND_SPEED * 0.621371;
  var r = $feature.R_HUMIDITY;

  // WIND CHILL

  var wc = 35.74 + (0.6215 * t) 
    - (35.75 * Pow(ws, 0.16)) 
    + (0.4275 * t * Pow(ws, 0.16));

  // HEAT INDEX

  var c1 = -42.379;
  var c2 = 2.04901523;
  var c3 = 10.14333127;
  var c4 = -0.22475541;
  var c5 = -0.00683783;
  var c6 = -0.05481717;
  var c7 = 0.00122874;
  var c8 = 0.00085282;
  var c9 = -0.00000199;

  var hi = c1 + (c2 * t) + (c3 * r) 
    + (c4 * t * r) + (c5 * t * t) 
    + (c6 * r * r) + (c7 * t * t * r) 
    + (c8 * t * r * r) + (c9 * t * t * r * r);

  var tempDiff = WHEN(  
      // Only for temps below 50F and WS > 3mph
      // wind chill must be lower than the temperature
    t <= 50 && ws >= 3 && wc < t, wc - t,
      // Only for temps above 80F
    t >= 80, hi - t, 
      0
  );
  
  return tempDiff;
</script>  

<script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/layers/GroupLayer",
    "esri/renderers/UniqueValueRenderer",
    "esri/renderers/SimpleRenderer",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/widgets/Legend",
    "dojo/dom",
    "dojo/on",
    "dojo/domReady!"
  ], function(Map, MapView, FeatureLayer, GroupLayer, 
    UniqueValueRenderer, SimpleRenderer,
    SimpleMarkerSymbol, Legend,
    dom, on
  ) {
    
    var serviceUrl = "https://tmservices1.esri.com/arcgis/rest/services/LiveFeeds/NOAA_METAR_current_wind_speed_direction/MapServer/0";
    
    var outFields = [ "ELEVATION", "STATION_NAME", "TEMP", "R_HUMIDITY", 
                     "WIND_SPEED", "WIND_CHILL", "HEAT_INDEX", "WEATHER" ];
    
    var popupTemplate = {
      title: "{STATION_NAME}",
      content: [{
        type: "fields",
        fieldInfos: [{
          fieldName: "ELEVATION",
        }, {
          fieldName: "TEMP",
        }, {
          fieldName: "R_HUMIDITY",
        }, {
          fieldName: "WIND_SPEED",
        }, {
          fieldName: "WIND_CHILL",
        }, {
          fieldName: "HEAT_INDEX",
        }, {
          fieldName: "WEATHER",
        }]
      }]
    };
    
    // Stores each arcade expression as a string variable 
    // to be used in renderers
    
    var windChillArcade = dom.byId("wind-chill").innerHTML;
    var heatIndexArcade = dom.byId("heat-index").innerHTML;
    var apparentTempArcade = dom.byId("apparent-temp").innerHTML;
    var feltTempDiffArcade = dom.byId("felt-temp-diff").innerHTML;

    var weatherStationLayer = new FeatureLayer({
      url: serviceUrl,
      outFields: outFields, 
      popupTemplate: popupTemplate,
      definitionExpression: "LONGITUDE <= -30 AND LONGITUDE >= -150"
    });
    
    var map = new Map({
      basemap: "dark-gray",
      layers: [ weatherStationLayer ]
    });
    
    var view = new MapView({
      container: "viewDiv",
      map: map,
      center: [ -95, 39 ],
      zoom: 3
    });
    
    var windChillRenderer = new SimpleRenderer({
      symbol: createSymbol("white"),
      visualVariables: [{
        type: "color",
        valueExpression: windChillArcade,
        valueExpressionTitle: "Wind chill",
        stops: [
          { value: 9, color: "#f8f8db" },
          { value: 23, color: "#82b1bf" },
          { value: 37, color: "#425970" }
        ]
      }]
    });
    
    var heatIndexRenderer = new SimpleRenderer({
      symbol: createSymbol("white"),
      visualVariables: [{
        type: "color",
        valueExpression: heatIndexArcade,
        valueExpressionTitle: "Heat index",
        stops: [
          { value: 84, color: "#fdf4d2" },
          { value: 88, color: "#df9465" },
          { value: 93, color: "#873634" }
        ]
      }]
    });
    
    var apparentTempRenderer = new SimpleRenderer({
      symbol: createSymbol("white"),
      visualVariables: [{
        type: "color",
        valueExpression: apparentTempArcade,
        valueExpressionTitle: "Apparent temperature (how it feels)",
        stops: [
          { value: -15, color: "#00C5FF" },
          { value: 12, color: "#BEE8FF" },
          { value: 32, color: "#fdf4d2" },
          { value: 64, color: "#FF7F7F" },
          { value: 87, color: "#E60000" }
        ]
      }]
    });
    
    var feltTempDiffRenderer = new SimpleRenderer({
      symbol: createSymbol("white"),
      visualVariables: [{
        type: "color",
        valueExpression: feltTempDiffArcade,
        valueExpressionTitle: "Difference between apparent temperature and measured air temperature",
        stops: [
          { value: -34, color: "#0571b0" },
          { value: -15, color: "#0571b0" },
          { value: 0, color: "#fdf4d2" },
          { value: 10, color: "#E60000" },
          { value: 17, color: "#E60000" }
        ]
      }]
    });
    
    weatherStationLayer.renderer = feltTempDiffRenderer;
    map.add(weatherStationLayer);

    view.then(function(){
      var legend = new Legend({
        view: view
      });
      
      view.ui.add(legend, "bottom-left");
    });

    function createSymbol (color){
      return new SimpleMarkerSymbol({
        color: color,
        size: "5px",
        outline: {
          width: 0.5,
          color: [ 92, 92, 92, 0.5 ]
        }
      });
    }
  });

</script>

</head>

<body>
  <div id="viewDiv"></div>
</body>

</html>