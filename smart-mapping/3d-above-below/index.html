
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <title>Generate above and below color visualization in 3D - 4.4</title>

  <link rel="stylesheet" href="https://jsdev.arcgis.com/4.4/esri/css/main.css">
  <link rel="stylesheet" href="https://jsdev.arcgis.com/4.4/dijit/themes/claro/claro.css">
  <script src="https://jsdev.arcgis.com/4.4/"></script>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #containerDiv {
      background-color: white;
      padding: 3px;
      text-align: center;
    }

    #title {
      font-size: 14pt;
      font-weight: 500;
    }

    .widget-background{
      background-color: white;
      font-size: 12pt;
      padding: 8px;
    }
  </style>

  <script>
    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Expand",
      "esri/widgets/BasemapGallery",
      "esri/renderers/smartMapping/creators/color",
      "esri/renderers/smartMapping/creators/size",
      "esri/renderers/smartMapping/symbology/color",
      "esri/renderers/smartMapping/statistics/histogram",
      "esri/widgets/ColorSlider",
      "esri/widgets/SizeSlider",
      "esri/core/lang",
      "esri/core/Collection",
      "dojo/on",
      "dojo/dom",
      "dojo/dom-construct",
      "dojo/domReady!"
    ], function(
      Map, SceneView, FeatureLayer, Expand, BasemapGallery, colorRendererCreator, sizeRendererCreator,
      colorSchemes, histogram,
      ColorSlider, SizeSlider, lang, Collection, on, dom, domConstruct
    ) {

      var colorFieldSelect = dom.byId("color-field-select");
      var sizeFieldSelect = dom.byId("size-field-select");
      var colorNormCheck = dom.byId("normalize-color-check");
      var sizeNormCheck = dom.byId("normalize-size-check");
      var themeOptions = dom.byId("theme-options");
      var colorSlider = null;
      var sizeSlider = null;

      var map = new Map({
        basemap: "streets"
      });

      // The minSize and maxSize of volumetric symbols are determined
      // based on the view/camera the data will be displayed in.

      var view = new SceneView({
        container: "viewDiv",
        map: map
      });

      // Create a BasemapGallery widget instance and set
      // its container to a div element

      var basemapGallery = new BasemapGallery({
        view: view,
        container: document.createElement("div")
      });

      // Create an Expand instance and set the content
      // property to the DOM node of the basemap gallery widget
      // Use an Esri icon font to represent the content inside
      // of the Expand widget

      var bgExpand = new Expand({
        view: view,
        content: basemapGallery.container,
        expandIconClass: "esri-icon-basemap"
      });

      // Add the expand instance to the ui

      view.ui.add(bgExpand, "top-right");



      // Create an Expand instance and set the content
      // property to the DOM node of the basemap gallery widget
      // Use an Esri icon font to represent the content inside
      // of the Expand widget

      var sizeSliderExpand = new Expand({
        view: view,
        content: dom.byId("size-container"),
        expandIconClass: "esri-icon-pie-chart"
      });

      // Add the expand instance to the ui

      view.ui.add(sizeSliderExpand, "top-left");




      // Create an Expand instance and set the content
      // property to the DOM node of the basemap gallery widget
      // Use an Esri icon font to represent the content inside
      // of the Expand widget

      var colorSliderExpand = new Expand({
        view: view,
        content: dom.byId("color-container"),
        expandIconClass: "esri-icon-environment-settings"
      });

      // Add the expand instance to the ui

      view.ui.add(colorSliderExpand, "top-left");

      // Create FeatureLayer instance with popupTemplate

      var layer = new FeatureLayer({
        portalItem: {
          id: "6ae2459463184669a7826eb772c5ec29"
        },
        visible: false
      });

      map.add(layer);

      layer.then(function(){
        view.goTo(layer.fullExtent);
      });

      view.then(generateRenderer);

      on(themeOptions, "change", function(evt){
        generateRenderer({ theme: evt.target.value });
      });

      basemapGallery.watch("activeBasemap", function(newVal){
        generateRenderer({ basemap: newVal });
      });

      on(colorFieldSelect, "change", function(evt){
        generateRenderer({ colorField: evt.target.value });
      });

      on(sizeFieldSelect, "change", function(evt){
        generateRenderer({ sizeField: evt.target.value });
      });

      on(colorNormCheck, "change", function(evt){
        generateRenderer();
      });

      function generateRenderer(params) {
        var colorSliderParams = {};
        var sizeSliderParams = {};

        var colorParams = {
          layer: params.layer ? params.layer : layer,
          basemap: params.basemap ? params.basemap : map.basemap,
          field: params.colorField ? params.colorField : colorFieldSelect.value,
          normalizationField: colorNormCheck.checked ? "ACSMARBASE" : null,
          view: view,
          symbolType: "3d-volumetric",
          theme: params.theme ? params.theme : themeOptions.value
        };

        var colorResponse = null;
        var sizeResponse = null;
        return colorRendererCreator.createContinuousRenderer(colorParams)
          .then(function(response) {

            colorResponse = response;

            return histogram({
              layer: colorParams.layer,
              field: colorParams.field
            });
          })
          .then(function(colorHistogram) {

            var sizeParams = {
              layer: params.layer ? params.layer : layer,
              field: params.sizeField ? params.sizeField : sizeFieldSelect.value,
              normalizationField: sizeNormCheck.checked ? "EDUCBASECY" : null,
              basemap: params.basemap ? params.basemap : map.basemap,
              view: view,
              worldScale: true,
              axis: "height"
            };

            return sizeRendererCreator.createVisualVariables(sizeParams)
              .then(function(response){

                sizeResponse = response;

                return histogram({
                  layer: sizeParams.layer,
                  field: sizeParams.field
                });
            }).then(function(sizeHistogram){



                if(!layer.visible){
                  layer.visible = true;
                }

                var renderer = colorResponse.renderer.clone();
                renderer.visualVariables = [];
                var colorVV = lang.clone(colorResponse.visualVariable);
                var sizeVVs = lang.clone(sizeResponse.visualVariables);
                renderer.visualVariables = sizeVVs;
                renderer.visualVariables.push(colorVV);
                layer.renderer = renderer;


                colorSliderParams.statistics = colorResponse.statistics;
                colorSliderParams.histogram = colorHistogram;
                colorSliderParams.visualVariable = colorVV;

                sizeSliderParams.statistics = sizeResponse.statistics;
                sizeSliderParams.histogram = histogram;

                var heightVV = sizeVVs.filter(function(vv){
                  return vv.axis === "height";
                })[0];
                sizeSliderParams.visualVariable = heightVV;

                // input the slider parameters in the slider's constructor
                // and add it to the view's UI

                if (!colorSlider) {

                  colorSliderParams.container = "color-slider";
                  colorSliderParams.numHandles = 3;
                  colorSliderParams.syncedHandles = true;
                  colorSlider = new ColorSlider(colorSliderParams);

                  // when the user slides the handle(s), update the renderer
                  // with the updated color visual variable object

                  on(colorSlider, "data-change", function() {
                    var renderer = layer.renderer.clone();

                    var visualVariables = lang.clone(renderer.visualVariables);
                    renderer.visualVariables = [];

                    var unchangedVV = visualVariables.filter(function(vv){
                      return vv.type !== "color";
                    });

                    renderer.visualVariables = visualVariables;
                    renderer.visualVariables.push(lang.clone(colorSlider.visualVariable));
                    layer.renderer = renderer;
                  });

                } else {
                  colorSlider.set(colorSliderParams);
                }

                if(!sizeSlider){
                  sizeSliderParams.container = "size-slider";
                  sizeSlider = new SizeSlider(sizeSliderParams);

                  // when the user slides the handle(s), update the renderer
                  // with the updated size visual variable objects

                  on(sizeSlider, "data-change", function() {
                    var renderer = layer.renderer.clone();

                    var visualVariables = lang.clone(renderer.visualVariables);
                    renderer.visualVariables = [];

                    var unchangedVV = visualVariables.filter(function(vv){
                      return vv.axis !== "height";
                    });

                    renderer.visualVariables = visualVariables;

                    renderer.visualVariables.push(lang.clone(sizeSlider.visualVariable));
                    layer.renderer = renderer;
                  });

                } else {
                  sizeSlider.set(sizeSliderParams);
                }

              });

          })
          .otherwise(function(err) {
            console.log("there was an error: ", err);
          });
      }

    });
  </script>
</head>

<body class="claro">
  <div id="viewDiv"></div>
  <div id="color-container" class="widget-background">
    Field: <select id="color-field-select">
      <option value="ACSNEVMARR">Never Married</option>
      <option value="ACSMARRIED" selected>Married</option>
      <option value="ACSWIDOWED">Widowed</option>
      <option value="ACSDIVORCD">Divorced</option>
      <option value="ACSMARBASE">Population 15+</option>
    </select>
    Normalize? <input type="checkbox" id="normalize-color-check"><br>
    Theme: <select id="theme-options">
      <option value="high-to-low" selected>High to low</option>
      <option value="centered-on">Centered on</option>
      <option value="extremes">Extremes</option>
      <option value="above-and-below">Above and below</option>
    </select><br>
    <div id="color-slider"></div>
  </div>
  <div id="size-container" class="widget-background">
    Field: <select id="size-field-select">
      <option value="nocollegedegree" selected>No college degree</option>
      <option value="SMCOLL_CY">Some college</option>
      <option value="ASSCDEG_CY">Associate degree</option>
      <option value="BACHDEG_CY">Bachelor degree</option>
      <option value="GRADDEG_CY">Graduate degree</option>
    </select>
    Normalize? <input type="checkbox" id="normalize-size-check"><br>
    <div id="size-slider"></div>
  </div>
</body>

</html>