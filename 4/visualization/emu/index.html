<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Intro to SceneLayer - 4.5</title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #filter-container {
      background-color: white;
      padding: 5px;
      width: 220px;
    }

    #title {
      font-size: 14pt;
      font-weight: 500;
    }

    #data-value {
      font-weight: bolder;
    }

    .widget-background{
      background-color: white;
      font-size: 12pt;
      padding: 8px;
    }
  </style>

  <link rel="stylesheet" href="https://jsdev.arcgis.com/4.5/esri/css/main.css">
  <link rel="stylesheet" href="https://jsdev.arcgis.com/4.5/dijit/themes/claro/claro.css">
  <script src="https://jsdev.arcgis.com/4.5/"></script>

  <script>
    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Expand",
      "esri/widgets/Legend",
      "esri/widgets/ColorSlider",
      "esri/widgets/LayerList",
      "esri/widgets/Home",
      "esri/Graphic",
      "esri/layers/GroupLayer",
      "esri/layers/GraphicsLayer",
      "esri/renderers/smartMapping/creators/color",
      "esri/renderers/smartMapping/statistics/histogram",
      "esri/core/lang",
      "dojo/domReady!"
    ], function(Map, SceneView, FeatureLayer, 
      Expand, Legend, ColorSlider, LayerList, Home,
      Graphic, GroupLayer, GraphicsLayer, 
      colorRendererCreator, histogram, lang
    ) {

      var colorFieldSelect = document.getElementById("color-field-select");
      var themeOptions = document.getElementById("theme-options");
      var depthFilter = document.getElementById("depth-filter");
      var dataFilter = document.getElementById("data-filter");
      var dataFilterValue = document.getElementById("data-value");
      var fieldNameValue = document.getElementById("field-name");
      var colorSlider = null;
      var cylinderSymbolsUsed = false;
      var dataMinElem = document.getElementById("data-min");
      var dataMaxElem = document.getElementById("data-max");
      var colorSlideEvent;
      var exaggeration = 500;

      var studyArea = {
        spatialReference: {
          latestWkid: 3857,
          wkid: 102100
        },
        xmin: 7834109,
        ymin: -69576,
        xmax: 8502026,
        ymax: 907517
      };

      var depth = -5000 * exaggeration;

      // Create Map
      var map = new Map({
        basemap: "satellite",
        ground: "world-elevation"
      });

      // Create the SceneView
      view = new SceneView({
        container: "viewDiv",
        viewingMode: "local",
        map: map,
        camera: {
          position: {
            spatialReference: {
              latestWkid: 3857,
              wkid: 102100
            },
            x: 9040444,
            y: -837938,
            z: 247393
          },
          heading: 325,
          tilt: 79
        },
        clippingArea: studyArea,
        // Allows for navigating the camera below the surface
        constraints: {
          collision: {
            enabled: false
          },
          tilt: {
            max: 179.99
          }
        },
        // Turns off atmosphere and stars settings
        environment: {
          atmosphere: null,
          starsEnabled: false
        }
      });

      function addDepthRuler (view, extent, depth){
        var ruler = new GraphicsLayer({
          graphics: [{
            geometry: {
              type: "polyline",
              spatialReference: view.spatialReference,
              hasZ: true,
              paths: [
                [
                  [extent.xmin, extent.ymax, 0],
                  [extent.xmin, extent.ymax, depth]
                ]
              ]
            },
            symbol: {
              type: "simple-line",
              width: 3,
              color: "orange"
            }
          }]
        });

        var rulerTickLayer = new FeatureLayer({
          objectIdField: "ObjectID",
          spatialReference: view.spatialReference,
          fields: [{
            name: "ObjectID",
            alias: "ObjectID",
            type: "oid"
          }, {
            name: "label",
            alias: "label",
            type: "double"
          }],
          geometryType: "point",
          source: createGraphics(200, depth),
          screenSizePerspectiveEnabled: false,
          featureReduction: null,
          labelsVisible: true,
          labelingInfo: [{
            symbol: {
              type: "label-3d",
              symbolLayers: [{
                type: "text",
                material: {
                  color: "orange"
                },
                size: 12
              }]
            },
            labelPlacement: "center-right",
            labelExpressionInfo: {
              expression: "$feature.label"
            }
          }],
          renderer: {
            type: "simple",
            symbol: {
              type: "point-3d", 
              symbolLayers: [{
                type: "icon",
                material: {
                  color: "orange"
                },
                resource: {
                  primitive: "cross"
                },
                size: 10,
                outline: {
                  color: "orange",
                  size: 3
                }
              }]
            }
          }
        });

        function createGraphics(interval, depth){
          var features = [];
          var trueDepth = Math.round(Math.abs(depth/exaggeration));
          for(var i = 0; i <= trueDepth; i+=interval){
            var depthValue = i === 0 ? i : -i;
            features.push(new Graphic({
              attributes: {
                ObjectID: i,
                label: "  " + Math.round(depthValue) + " m"
              },
              geometry: {
                type: "point",
                spatialReference: view.spatialReference,
                x: extent.xmin,
                y: extent.ymax,
                z: depthValue * exaggeration
              }
            }));
          }
          return features;
        }

        var depthRuler = new GroupLayer({
          title: "Depth ruler",
          listMode: "hide-children",
          layers: [ ruler, rulerTickLayer],
          visible: false
        });

        view.map.add(depthRuler);
      }

      // Create SceneLayer and add to the map
      layer = new FeatureLayer({
        title: "EMU data points",
        portalItem: {
          id: "cfbc577e961342688b6c5dc6d246c58f"
        },
        outFields: ["*"],
        // screenSizePerspectiveEnabled: false,
        elevationInfo: {
          mode: "relative-to-ground",
          featureExpressionInfo: {
            expression: "$feature.UnitTop" + "*" + exaggeration
          },
          unit: "meters"
        },
        definitionExpression: "UnitTop >= -300"
      });
      map.add(layer);

      view.then(function(){
        addDepthRuler(view, studyArea, depth);
        layer.then(function(){

          layer.queryFeatureCount().then(function(r){
            console.log("count: ", r);
          });

          generateContinuousVisualization();

          depthFilter.addEventListener("change", filterChange);
          dataFilter.addEventListener("change", filterChange);
          dataFilter.addEventListener("input", function(event){
            dataFilterValue.innerText = Math.round(event.target.value*100) / 100;
          });
          symbolCheck.addEventListener("click", function(){
            generateContinuousVisualization();
          })

          function filterChange (evt){
            var depthExpression = depthFilter.value;
            var dataExpression = colorFieldSelect.value + " <= " + dataFilter.value;
            // var expression = depthExpression;

            if(depthExpression){
              if(dataExpression){
                expression = "(" + depthExpression + ") AND (" + dataExpression + ")";
              } else {
                expression = depthExpression;
              }
            } else {
              expression = dataExpression;
            }

            layer.definitionExpression = expression;
          }

          function definitionExpressionHasValue(expression, value){
            return expression.indexOf(value) > -1;
          }


        });
      });

      ///////////////////////////////////////
      //
      // Widgets
      //
      //////////////////////////////////////

      // Home

      view.ui.add(new Home({
        view: view
      }), "top-left");

      // LayerList

      var layerList = new LayerList({
        view: view,
        container: document.createElement("div"),
        listItemCreatedFunction: function(event){
          var item = event.item;
          if(item.title === layer.title){
            item.actionsSections = [[{
              title: "Toggle 3D cylinders",
              className: "esri-icon-public",
              id: "toggle-3d-cylinders"
            }]];
          }

        }
      });
      layerList.on("trigger-action", function(event){
        if(event.action.id === "toggle-3d-cylinders"){
          cylinderSymbolsUsed = !cylinderSymbolsUsed;
          generateContinuousVisualization();
        }
      });

      var layerListExpand = new Expand({
        view: view,
        content: layerList.container,
        expandIconClass: "esri-icon-layer-list"
      });
      view.ui.add(layerListExpand, "top-left");

      // Legend

      var legend = new Legend({
        view: view,
        container: document.createElement("div"),
        layerInfos: [{
          layer: layer
        }]
      });

      var legendExpand = new Expand({
        view: view,
        content: legend.container,
        expandIconClass: "esri-icon-key"
      });
      view.ui.add(legendExpand, "top-left");

      // Color Slider

      var colorSliderExpand = new Expand({
        view: view,
        content: document.getElementById("color-container"),
        expandIconClass: "esri-icon-chart"
      });
      view.ui.add(colorSliderExpand, "top-left");

      // Filters

      var filtersExpand = new Expand({
        view: view,
        content: document.getElementById("filter-container"),
        expandIconClass: "esri-icon-filter"
      });
      view.ui.add(filtersExpand, "top-left");

      // Expands

      layerListExpand.watch("expanded", function(expanded){
        var otherWidgetsExpanded = colorSliderExpand.expanded || 
          legendExpand.expanded || filtersExpand.expanded;

        if(expanded && otherWidgetsExpanded){
          colorSliderExpand.collapse();
          legendExpand.collapse();
          filtersExpand.collapse();
        }
      });

      colorSliderExpand.watch("expanded", function(expanded){
        var otherWidgetsExpanded = layerListExpand.expanded || 
          legendExpand.expanded || filtersExpand.expanded;

        if(expanded && otherWidgetsExpanded){
          layerListExpand.collapse();
          legendExpand.collapse();
          filtersExpand.collapse();
        }
      });

      legendExpand.watch("expanded", function(expanded){
        var otherWidgetsExpanded = colorSliderExpand.expanded || 
          layerListExpand.expanded || filtersExpand.expanded;

        if(expanded && otherWidgetsExpanded){
          colorSliderExpand.collapse();
          layerListExpand.collapse();
          filtersExpand.collapse();
        }
      });

      filtersExpand.watch("expanded", function(expanded){
        var otherWidgetsExpanded = colorSliderExpand.expanded || 
          legendExpand.expanded || layerListExpand.expanded;

        if(expanded && otherWidgetsExpanded){
          colorSliderExpand.collapse();
          legendExpand.collapse();
          layerListExpand.collapse();
        }
      });

      function changeEventListener(event){
        if(colorFieldSelect.value === "Cluster37"){
          themeOptions.disabled = true;
          getEMUClusterVisualization();
          destroyColorSlider();
        } else {
          themeOptions.disabled = false;
          generateContinuousVisualization();
        }
      }

      colorFieldSelect.addEventListener("change", changeEventListener);
      themeOptions.addEventListener("change", changeEventListener);

      function getNumHandles(theme){
        return theme === "high-to-low" ? 2 : 3;
      }

      function getEMUClusterVisualization(){
        
        var symbolType = cylinderSymbolsUsed ? "object" : "icon";

        var renderer = {
          type: "unique-value",
          field: "Cluster37",
          defaultSymbol: createSymbol("darkgray", symbolType),
          defaultLabel: "no classification",
          uniqueValueInfos: [{
            value: 10, 
            label: "EMU 10",
            symbol: createSymbol([117,112,230], symbolType)
          }, {
            value: 13, 
            label: "EMU 13",
            symbol: createSymbol([54,71,153], symbolType)
          }, {
            value: 33, 
            label: "EMU 33",
            symbol: createSymbol([117,145,255], symbolType)
          }, {
            value: 24, 
            label: "EMU 24",
            symbol: createSymbol([235,169,212], symbolType)
          }, {
            value: 26, 
            label: "EMU 26",
            symbol: createSymbol([147,101,230], symbolType)
          }, {
            value: 18, 
            label: "EMU 18",
            symbol: createSymbol([235,150,204], symbolType)
          }, {
            value: 36, 
            label: "EMU 36",
            symbol: createSymbol([26,82,170], symbolType)
          }, {
            value: 14, 
            label: "EMU 14",
            symbol: createSymbol([70,82,144], symbolType)
          }]
        };

        if(symbolType === "object"){
          renderer.visualVariables = [{
            type: "size",
            valueExpression: "$feature.ThicknessPos" + " * " + exaggeration,
            valueUnit: "meters",
            axis: "height"
          }, {
            type: "size",
            useSymbolValue: true,
            axis: "width-and-depth"
          }];
        }

        layer.renderer = renderer;
      }

      function destroyColorSlider(){
        colorSlider.destroy();
        colorSlideChangeEvent.remove();
        colorSlideSlideEvent.remove();
        colorSlider = null;
      }

      function createSymbol(color, type){
        return {
          type: "point-3d",
          symbolLayers: [{
            type: type,  // icon | object
            resource: {
              primitive: type === "object" ? "cylinder" : "circle"
            },
            material: {
              color: color ? color : "white"
            },
            size: type === "icon" ? 5 : null,
            width: type === "object" ? 7000 : null,
            anchor: type === "object" ? "top" : null
          }]
        };
      }

      function generateContinuousVisualization(){
        var symbolType = cylinderSymbolsUsed ? "object" : "icon";

        var options = {
          layer: layer,
          basemap: map.basemap,
          field: colorFieldSelect.value,
          view: view,
          theme: themeOptions.value,
          view: symbolType === "object" ? view : null,
          worldScale: symbolType === "object"
        };

        var renderer = {
          type: "simple",
          symbol: createSymbol("white", symbolType)
        }

        var containsIconSymbol = renderer.symbol.symbolLayers.some(function(sl){
          return sl.type === "icon";
        });

        if(!containsIconSymbol){
          renderer.visualVariables = [{
            type: "size",
            valueExpression: "$feature.ThicknessPos" + "*" + exaggeration,
            valueUnit: "meters",
            axis: "height"
          }, {
            type: "size",
            useSymbolValue: true,
            axis: "width-and-depth"
          }];
        }
        
        var colorResponse, colorVV;
        colorRendererCreator.createVisualVariable(options)
          .then(function(response){
            colorResponse = response;
            colorVV = response.visualVariable;

            if(renderer.visualVariables && renderer.visualVariables.length > 1){
              renderer.visualVariables.push(colorVV);
            } else {
              renderer.visualVariables = [ colorVV ];
            }
            layer.renderer = renderer;

            var min = colorResponse.statistics.min;
            var max = colorResponse.statistics.max;
            var stddev = colorResponse.statistics.stddev * 0.33;
            
            fieldNameValue.innerText = colorFieldSelect.value;
            dataFilter.min = min;
            dataMinElem.innerText = Math.round(min*100) / 100;
            dataFilter.max = max + stddev;
            dataMaxElem.innerText = Math.round(max*100) / 100;
            dataFilter.value = max;
            dataFilterValue.innerText = Math.round(max*100) / 100;
            dataFilter.step = stddev;

            return histogram({
              layer: options.layer,
              field: options.field,
              numBins: 30
            });
          }).then(function(colorHistogram) {
            var colorSliderParams = {
              statistics: colorResponse.statistics,
              maxValue: colorResponse.statistics.max,
              minValue: colorResponse.statistics.min,
              histogram: colorHistogram,
              visualVariable: colorVV,
              numHandles: getNumHandles(options.theme),
              syncedHandles: getNumHandles(options.theme) > 2
            };

            // input the slider parameters in the slider's constructor
            // and add it to the view's UI

            if (!colorSlider) {

              var colorSliderParent = document.getElementById("color-container");
              var colorSliderContainer = document.createElement("div");
              colorSliderParent.appendChild(colorSliderContainer);
              colorSliderParams.container = colorSliderContainer;

              colorSlider = new ColorSlider(colorSliderParams);

              // when the user slides the handle(s), update the renderer
              // with the updated color visual variable object

              colorSlideChangeEvent = colorSlider.on("handle-value-change", function() {
                var renderer = layer.renderer.clone();

                if(renderer.visualVariables.length <= 1){
                  return;
                }

                var visualVariables = lang.clone(renderer.visualVariables);
                layer.renderer.visualVariables = [];

                if(visualVariables){
                  var unchangedVVs = visualVariables.filter(function(vv){
                    return vv.type !== "color";
                  });
                  renderer.visualVariables = unchangedVVs.concat([lang.clone(colorSlider.visualVariable)]);
                } else {
                  // renderer.visualVariables.pop();
                  renderer.visualVariables.push(lang.clone(colorSlider.visualVariable));
                }
                layer.renderer = renderer;
              });

              colorSlideSlideEvent = colorSlider.on("data-change", function() {
                var renderer = layer.renderer.clone();
                if(renderer.visualVariables.length > 1){
                  return;
                }
                renderer.visualVariables = [ lang.clone(colorSlider.visualVariable) ];
                layer.renderer = renderer;
              });

            } else {
              colorSlider.set(colorSliderParams);
            }
          });
      }

    });
  </script>
</head>

<body class="claro">
  <div id="viewDiv"></div>
  <div id="color-container" class="widget-background">
    <h3></h3>
    Field: &nbsp;&nbsp;&nbsp;<select id="color-field-select" class="esri-widget">
      <option value="Cluster37">EMU Cluster</option>
      <option value="temp">Temperature</option>
      <option value="salinity" selected>Salinity</option>
      <option value="appO2ut">Apparent O2</option>
      <option value="dissO2">Dissolved O2</option>
      <option value="nitrate">Nitrate</option>
      <option value="percO2sat">% O2 Saturation</option>
      <option value="phosphate">Phosphate</option>
      <option value="silicate">Silicate</option>
      <option value="ChlorA_12yrAvg">ChlorA (12 yr avg)</option>
    </select><br>
    Theme: <select id="theme-options" class="esri-widget">
      <option value="high-to-low">High to low</option>
      <option value="centered-on">Centered on</option>
      <option value="extremes">Extremes</option>
      <option value="above-and-below" selected>Above and below</option>
    </select>
  </div>
  <div id="filter-container" class="esri-widget">
    <div>
      Depth: <select id="depth-filter" class="esri-widget">
        <option value="1=1">none</option>
        <option value="UnitTop >= -300" selected>0 - 300m +</option>
        <option value="UnitTop >= -1100 AND UnitTop <= -300">300m - 1100m</option>
        <option value="UnitTop >= -2400 AND UnitTop <= -1100">1100m - 2400m</option>
        <option value="UnitTop <= -2400">> 2400m</option>
      </select>
  </div>
  <div>
    <span id="field-name"></span> values less than <span id="data-value"></span><br>
    <span id="data-min">0</span><input type="range" id="data-filter" min="0" max="38" step="1" class="esri-widget"><span id="data-max">38</span>
  </div>
  </div>
</html>