<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Population change from night to day</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/dark/main.css">
    <script src="https://js.arcgis.com/4.11/"></script>

    <style>
      html,
      body,
      #viewDiv {
          padding: 0;
          margin: 0;
          height: 100%;
          width: 100%;
      }
    </style>

    <script>
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/GroupLayer",
        "esri/renderers/DotDensityRenderer",
        "esri/widgets/Legend",
        "esri/widgets/Search",
        "esri/widgets/LayerList",
        "esri/widgets/Expand"
      ], function(WebMap, MapView, FeatureLayer, GroupLayer, DotDensityRenderer, Legend, Search, LayerList, Expand) {

        const map = new WebMap({
          portalItem: { id: "1817165774bc4cd4a31c8c0477ff4866" }
        });

        view = new MapView({
          container: "viewDiv",
          map: map,
          highlightOptions: {
            fillOpacity: 0,
            color: "white"
          },
          constraints: {
            maxScale: 144447
          }
        });
        view.ui.add(new Legend({ view: view }), "bottom-left");

        view.ui.add(new Expand({
          group: "top-left",
          view: view,
          content: new Search({ 
            view: view,
            resultGraphicEnabled: false,
            popupEnabled: false
          })
        }), "top-left");
        
        view.ui.add(new Expand({
          group: "top-left",
          view: view,
          expanded: true,
          content: new LayerList({
            view: view,
            listItemCreatedFunction: function (event) {
              const item = event.item;
              const validTitles = [
                "Population change from night to day",
                "Nighttime Population",
                "Daytime population"
              ];
              item.open = true;
            }
          })
        }), "top-left");

        view.when().then(function(){

          const url = "https://services.arcgis.com/jIL9msH9OI208GCb/arcgis/rest/services/USA_Daytime_Population_2016/FeatureServer/2";
        
          const changeRenderer = new DotDensityRenderer({
            referenceDotValue: 400,
            outline: null,
            referenceScale: 577790,
            // referenceDotValue: 500,
            // outline: {
            //   width: 0.5,
            //   color: [ 250,250,250,0.1 ]
            // },
            legendOptions: {
              unit: "people"
            },
            attributes: [
              {
                valueExpression: "$feature.DPOP_CY - $feature.TOTPOP_CY",
                color: [255,255,0,1],
                label: "Population growth at daytime"
              }, {
                valueExpression: "IIF($feature.DPOP_CY - $feature.TOTPOP_CY < 0, Abs($feature.DPOP_CY - $feature.TOTPOP_CY), 0)",
                color: [ 0,255,255,1],
                label: "Population growth at nighttime"
              }
            ]
          });

          const changeLayer = new FeatureLayer({
            url: url,
            renderer: changeRenderer,
            visible: true,
            minScale: 0,
            title: "Population change from night to day",
            popupTemplate: {
              content: "Daytime pop change: <b>{expression/difference}</b>",
              expressionInfos: [{
                expression: "$feature.DPOP_CY - $feature.TOTPOP_CY",
                title: "difference",
                name: "difference"
              }]
            }
          });

          const dayTimePopulation = new FeatureLayer({
            url: url,
            renderer: new DotDensityRenderer({
              referenceDotValue: 500,
              outline: null,
              legendOptions: {
                unit: "people"
              },
              attributes: [
                {
                  field: "DPOP_CY",
                  color: [255,255,0,1],
                  label: "Daytime population"
                }
              ]
            }),
            visible: false,
            minScale: 0,
            title: "Daytime population",
            popupTemplate: {
              content: "Daytime pop change: <b>{expression/difference}</b>",
              expressionInfos: [{
                expression: "$feature.DPOP_CY",
                title: "difference",
                name: "difference"
              }]
            }
          });

          const nighTimePopulation = new FeatureLayer({
            url: url,
            renderer: new DotDensityRenderer({
              referenceDotValue: 500,
              outline: null,
              legendOptions: {
                unit: "people"
              },
              attributes: [
                {
                  field: "TOTPOP_CY",
                  color: [ 0,255,255,1],
                  label: "Nighttime Population"
                }
              ]
            }),
            visible: false,
            minScale: 0,
            title: "Nighttime Population",
            popupTemplate: {
              content: "Daytime pop change: <b>{expression/difference}</b>",
              expressionInfos: [{
                expression: "$feature.DPOP_CY",
                title: "difference",
                name: "difference"
              }]
            }
          });

          const allLayers = new GroupLayer({
            title: "Population in daytime vs. nighttime",
            layers: [ dayTimePopulation, nighTimePopulation, changeLayer ],
            visibilityMode: "exclusive"
          });

          map.add(allLayers);
        }).catch(function(error){
          console.error(error);
        });

      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>

</html>
